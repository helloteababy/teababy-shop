## Varnish Cache ##

### What's Varnish? ###

> Varnish Cache is a web application accelerator also known as a caching HTTP reverse proxy. You install it in front of any server that speaks HTTP and configure it to cache the contents. Varnish Cache is really, really fast. It typically speeds up delivery with a factor of 300 - 1000x, depending on your architecture. 

<Warning>
*Do not use Varnish service before your site is all set*
</Warning>

### How to use Varnish in brief? ###

**Varnish** is typically a proxy hence need to combine the use of **Apache**, put Varnish in the front and set port as 80 as all broswers use this default port, and change Apache localhost port to 127.0.0.1:8080 as backend server, remember to make this change in both /usr/local/apache/conf/httpd.conf and all vhosts on your website under /usr/local/apache/conf/vhost/mysite.com.conf

Then type commands below to start:

`/etc/init.d/httpd stop`
`service varnish stop`
`service varnish start`
`/etc/init.d/httpd start`

Once Varnish is working, you need to add some plugins like **WP Super Cache** to purge cached data whenever you make changes to the site or the site won't update with your changes.

### Install and configure Varnish ##

`yum install varnish` With CentOS 7 this command will install varnish version 4 only.
`chkconfig varnish on` This will enable varnish always.

Edit config below and change the port to 80.

> vi /etc/varnish/varnish.params

> VARNISH_LISTEN_PORT=80

**/etc/varnish/default.vcl**

This file defines what the backend server is ex. apache 127.0.0.1:8080 and define the ACL for purging so that WP Super Cache can purge if needed.

Check this [config model](https://wiki.mikejung.biz/Varnish) if wanna more detailed tunning.

Below is my config of /etc/varnish/default.vcl

```
# Default backend definition. Set this to point to your content server.
backend default {
    .host = "127.0.0.1";
    .port = "8080";
}

acl purge {
        "localhost";
}

sub vcl_recv {
    # Happens before we check if we have this in cache already.
    #
    # Typically you clean up the request here, removing cookies you don't need,
    # rewriting the request, etc.

    # Disable cache tracking cookies generated by Wordpress.

  set req.http.cookie = regsuball(req.http.cookie, "wp-settings-\d+=[^;]+(; )?", "");

  set req.http.cookie = regsuball(req.http.cookie, "wp-settings-time-\d+=[^;]+(; )?", "");

  set req.http.cookie = regsuball(req.http.cookie, "wordpress_test_cookie=[^;]+(; )?", "");

  if (req.http.cookie == "") {

  unset req.http.cookie;
  }

        # allow PURGE from localhost..

        if (req.method == "PURGE") {
                if (!client.ip ~ purge) {
                        return(synth(405,"Not allowed."));
                }
                return (purge);
        }

}

sub vcl_backend_response {
    # Happens after we have read the response headers from the backend.
    #
    # Here you clean the response headers, removing silly Set-Cookie headers
    # and other mistakes your backend does.

    # Set the time Varnish Cache lasts for 1 hour instead of default 2 minutes.
  if (beresp.ttl == 120s) {

    set beresp.ttl = 12h;
  }
}
```

### Prevent pages from cached to avoid cart empty ###

```
if (req.url ~ "^/(cart|my-account|checkout|addons)") {
 return (pass);
 }
if ( req.url ~ "\?add-to-cart=" ) {
 return (pass);
 }
```

### Why is my Varnish configuration not working in WooCommerce? ###

Check out the following WordPress.org Support forum post on [how cookies may be affecting your varnish coding].(https://wordpress.org/support/topic/varnish-configuration-not-working-in-woocommerce)

```
Add this to vcl_recv above "if (req.http.cookie) {":

# Unset Cookies except for WordPress admin and WooCommerce pages 
if (!(req.url ~ "(wp-login|wp-admin|cart|my-account/*|wc-api*|checkout|addons|logout|lost-password|product/*)")) { 
unset req.http.cookie; 
} 
# Pass through the WooCommerce dynamic pages 
if (req.url ~ "^/(cart|my-account/*|checkout|wc-api/*|addons|logout|lost-password|product/*)") { 
return (pass); 
} 
# Pass through the WooCommerce add to cart 
if (req.url ~ "\?add-to-cart=" ) { 
return (pass); 
} 
# Pass through the WooCommerce API
if (req.url ~ "\?wc-api=" ) { 
return (pass); 
} 
# Block access to php admin pages via website 
if (req.url ~ "^/phpmyadmin/.*$" || req.url ~ "^/phppgadmin/.*$" || req.url ~ "^/server-status.*$") { 
error 403 "For security reasons, this URL is only accesible using localhost (127.0.0.1) as the hostname"; 
} 
#

Add this to vcl_fetch:

# Unset Cookies except for WordPress admin and WooCommerce pages 
if ( (!(req.url ~ "(wp-(login|admin)|login|cart|my-account/*|wc-api*|checkout|addons|logout|lost-password|product/*)")) || (req.request == "GET") ) { 
unset beresp.http.set-cookie; 
} 
#
```

### Why is my Password Reset stuck in a loop? ###

This is due to the My Account page being cached, Some hosts with server side caching don’t prevent the following file from being cached:

> my-account.php

If you’re unable to reset your password and keep being returned to the login screen, please speak to your host to make sure this page is being excluded from their caching.

### Reference: ###
1. [How to put varnish cache on your wordpress site](https://blog.pair.com/2017/09/08/put-varnish-cache-wordpress-site/)
2. [Purging and banning on Varnish users guide](https://varnish-cache.org/docs/trunk/users-guide/purging.html)
3. [Configuring caching plugins](https://docs.woocommerce.com/document/configuring-caching-plugins/)
